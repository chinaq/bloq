# Abp Deploy on Docker

- [Abp Deploy on Docker](#abp-deploy-on-docker)
  - [相关并解决](#相关并解决)
    - [angular 在 docker 中的 env 替换](#angular-在-docker-中的-env-替换)
    - [nginx 的 docker 部署 angular](#nginx-的-docker-部署-angular)
    - [dotnet/sdk 的 docker 镜像选择](#dotnetsdk-的-docker-镜像选择)
    - [container 内部调试](#container-内部调试)
    - [yarn build:prod 在 docker 中内存不足](#yarn-buildprod-在-docker-中内存不足)
    - [docker-compose build 为什么没有生成镜像](#docker-compose-build-为什么没有生成镜像)
    - [mkcert 生成本地 https 证书](#mkcert-生成本地-https-证书)
    - [abp 设置默认本地化](#abp-设置默认本地化)
  - [其他相关](#其他相关)

## 相关并解决

### angular 在 docker 中的 env 替换
- 如之前使用的 react docker 一样，环境变量需要在 build 时，以 ARG 参数的形式传入
- 由于 Angular 中是以 Enviroment class 的形式存在的，所有需要使用 envsubst 工具进行替换
- [Using environment variables from docker-compose.yml in Angular app](https://stackoverflow.com/questions/58208540/using-environment-variables-from-docker-compose-yml-in-angular-app)
- example
  ``` yml
  # docker-compose.yml

  ...
    args: 
    - "APP_NAME=${ANGULAR_APP_NAME}
  ...
  ```
  ``` Dockerfile
  # Dockerfile

  ...
  ARG APP_NAME
  ENV APP_NAME=$APP_NAME
  RUN envsubst < environment.envsubst.ts > environment.prod.ts
  ...
  ```

### nginx 的 docker 部署 angular
- [Build and run Angular application in a Docker container](https://wkrzywiec.medium.com/build-and-run-angular-application-in-a-docker-container-b65dbbc50be8)
- [How To Use the Official NGINX Docker Image](https://www.docker.com/blog/how-to-use-the-official-nginx-docker-image/)


### dotnet/sdk 的 docker 镜像选择
- 经常会出现 dotnet restore 的时候，无法连接 nuget，需要替换镜像，如 `mcr.microsoft.com/dotnet/sdk:5.0-focal`
- [Nuget errors when restoring dotnet app inside Docker](https://github.com/dotnet/dotnet-docker/issues/2547#issuecomment-768517850)

### container 内部调试
- 当 container 已经停止时，可以使其生成新 image 再以新 container 的方式运行进入
- [docker exec into a stopped container](https://github.com/moby/moby/issues/18078#issuecomment-158525729)

### yarn build:prod 在 docker 中内存不足
- 增加 swap 容量
- mac 上直接 gui 设置
- linux 上参见 - [CentOS 7下添加swap文件 - 华为云](https://www.huaweicloud.com/articles/b8fccb16283fd8f7064591c079775bb7.html)

### docker-compose build 为什么没有生成镜像
- 一定要在 service 下使用 image 属性，要不只会在本地产生 image
- `docker-compose -H xxx` 先是在本地产生 image 再于 host 上使用该 cache 生成 image

### mkcert 生成本地 https 证书
- [localhost HTTPS subdomains with a Kestrel SSL certificate](https://solrevdev.com/2020/03/06/localhost-https-subdomains-with-a-kestrel-ssl-certificate.html)

### abp 设置默认本地化
- [How to set default Language in ABP framework?](https://stackoverflow.com/questions/66349570/how-to-set-default-language-in-abp-framework)


## 其他相关
- [centos 7 开放指定端口](https://www.jianshu.com/p/c379469d7134)
- [3 Ways to View and Log the SQL Generated by Entity Framework Core 5](https://eamonkeane.dev/3-ways-to-view-sql-generated-by-entity-framework-core-5/)